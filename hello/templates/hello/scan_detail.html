{% load widget_tweaks %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Details</title>
     {% load static %}
        <link rel="stylesheet" type="text/css" href="{% static 'hello/scanDetails5Alt.css' %}" />
</head>
<body>
    <div class="dashUBod">
        <div class="overlayTop">
            <a class="logoCorection" href="{% url 'patient_dashboard' %}">
            <svg width="75" height="75" viewBox="0 0 75 75" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="75" height="75" rx="15" fill="#6C63FF"/>
            <path d="M44 8C46.2091 8 48 9.79086 48 12V28H64C66.2091 28 68 29.7909 68 32V44C68 46.2091 66.2091 48 64 48H48V64C48 66.2091 46.2091 68 44 68H32C29.7909 68 28 66.2091 28 64V48H12C9.79086 48 8 46.2091 8 44V32C8 29.7909 9.79086 28 12 28H28V12C28 9.79086 29.7909 8 32 8H44Z" fill="white"/>
            <path d="M40.5 60.5C40.1878 62.061 38.1259 63.7686 37.2926 63.9353C36.5413 64.1776 36.4864 63.0477 37.2926 61.4353C38.7926 58.4353 36.0604 57.703 34.2926 55.9353C31.2926 52.9353 30.3794 46.7515 38.2926 42.4352C43.7926 39.4352 43.503 37.2904 37.7926 34.4352C34.7926 32.9352 29.7301 27.9352 31.2926 22.9352C32.8045 19.5294 34.5852 18.5567 37.7926 18.5284C40.15 18.5075 40.6134 18.5284 42.5 19C44 19.375 44.5146 21.9647 44 22.5C43 22.9352 41.1108 23.3185 39.7926 22.4352C35.7926 21.9352 32.5629 25.7949 41.7926 31.4352C50.7926 36.9352 45.2926 43.6852 38.7926 46.9352C34.7926 48.9352 35.7926 52.9353 37.7926 54.4353C39.7926 55.9353 41 58 40.5 60.5Z" fill="#6C63FF"/>
            </svg>
            </a>
            <div class="infoBox2">
                    <div class="dashboardTextColumn">
                        <!-- <div class="dashboardText">Scan Search</div> -->
                       
                        <div class="dashboardText">Scan Details
                            
                        </div>
                       
                        
                    </div>
                    
                </div>
                
                <div class="helloBox">
                    <div id="currentTime" class="dateDisplay2"></div>
                    <div class="vertSep"></div>
                    <div class="dateDisplay"><span id="day"></span></div>
                    <div class="dateDisplay2" id="monthYear"></div>
                </div>
            <!--  -->
            <div class="logoutBox">
                <a href="{% url 'settingsDr' %}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="27" height="27" viewBox="0 0 27 27" fill="none">
                    <path d="M13.5001 12.6162C15.0025 12.6162 16.4433 11.9516 17.5057 10.7686C18.568 9.58562 19.1648 7.98113 19.1648 6.30811C19.1648 4.6351 18.568 3.0306 17.5057 1.8476C16.4433 0.664603 15.0025 0 13.5001 0C11.9977 0 10.5568 0.664603 9.49449 1.8476C8.43214 3.0306 7.83532 4.6351 7.83532 6.30811C7.83532 7.98113 8.43214 9.58562 9.49449 10.7686C10.5568 11.9516 11.9977 12.6162 13.5001 12.6162ZM13.5001 15.3877C5.96841 15.3877 1.14019 22.2695 1.14019 22.2695C1.14019 22.2695 -1.42525 25.3161 1.14019 26.4774C2.53923 27.1742 24.4605 27.1742 25.86 26.4774C28.425 25.3161 25.86 22.2695 25.86 22.2695C25.86 22.2695 21.2891 15.3877 13.5001 15.3877Z" fill="#9BAAF5"/>
                    </svg>
                </a>
                <a class="logoutButton" href="{% url 'logout' %}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="24" viewBox="0 0 30 24" fill="none">
                    <path d="M28 2V22" stroke="#9BAAF5" stroke-width="2.5" stroke-linecap="round"/>
                    <path d="M2 10.75C1.30964 10.75 0.75 11.3096 0.75 12C0.75 12.6904 1.30964 13.25 2 13.25L2 10.75ZM25.8839 12.8839C26.372 12.3957 26.372 11.6043 25.8839 11.1161L17.9289 3.16116C17.4408 2.67301 16.6493 2.67301 16.1612 3.16116C15.673 3.64932 15.673 4.44078 16.1612 4.92893L23.2322 12L16.1612 19.0711C15.673 19.5592 15.673 20.3507 16.1612 20.8388C16.6493 21.327 17.4408 21.327 17.9289 20.8388L25.8839 12.8839ZM2 12L2 13.25L25 13.25L25 12L25 10.75L2 10.75L2 12Z" fill="#9BAAF5"/>
                    </svg>
                </a>

            </div>

        </div>
    </div>
    <div class="dashLBod">
        <div class="overlayBottom">
            <div class="rowAlign1">
                <div class="scanTypePt">{{ scan.scan_type }} Scan for {{ scan.patient.username }}</div>
                
                
                <a href="{% url 'generate_scan_pdf' scan.id %}" class="btn-primary1" target="_blank">
                    <svg xmlns="http://www.w3.org/2000/svg" width="33" height="43" viewBox="0 0 33 43" fill="none">
                    <path d="M28 0C30.7614 0 33 2.23858 33 5V37.1035C33 39.8649 30.7614 42.1035 28 42.1035H5C2.2386 42.1035 3.71563e-05 39.8649 0 37.1035V5C3.60683e-06 2.23858 2.23858 8.05322e-08 5 0H28ZM13.9639 27.3105V32.3018H8.58594L16.4492 39.8271L24.3125 32.3018H19.0361V27.3105H13.9639ZM6.45703 3.41406C4.7763 3.4141 3.41406 4.80362 3.41406 6.51758V32.8965C3.41406 34.6105 4.7763 36 6.45703 36H10.8877L9.80859 34.9658H6.45703C5.33655 34.9658 4.42871 34.0392 4.42871 32.8965V6.51758C4.42871 5.37494 5.33655 4.44828 6.45703 4.44824H26.543C27.6635 4.44828 28.5713 5.37494 28.5713 6.51758V32.8965C28.5713 34.0392 27.6635 34.9658 26.543 34.9658H23.1914L22.1123 36H26.543C28.2238 36 29.5859 34.6105 29.5859 32.8965V6.51758C29.5859 4.80362 28.2238 3.4141 26.543 3.41406H6.45703ZM8.18359 14.8496V21.6211H9.38672V19.333H10.6572C11.1695 19.333 11.601 19.2366 11.9512 19.0449C12.3013 18.851 12.5657 18.5853 12.7451 18.248C12.9245 17.9109 13.0146 17.525 13.0146 17.0908C13.0146 16.6611 12.9244 16.2776 12.7451 15.9404C12.5679 15.6013 12.3057 15.3345 11.958 15.1406C11.6122 14.9467 11.1839 14.8496 10.6738 14.8496H8.18359ZM14.0596 14.8496V21.6211H16.3096C16.9839 21.6211 17.5612 21.485 18.041 21.2139C18.5229 20.9428 18.8915 20.5538 19.1465 20.0469C19.4036 19.54 19.5322 18.9338 19.5322 18.2285C19.5322 17.5255 19.4044 16.9218 19.1494 16.417C18.8944 15.9123 18.5293 15.5247 18.0537 15.2559C17.5804 14.9848 17.0137 14.8496 16.3545 14.8496H14.0596ZM20.6748 14.8496V21.6211H21.8779V18.7441H24.6367V17.7158H21.8779V15.8779H24.9287V14.8496H20.6748ZM16.2871 15.9111C16.7366 15.9112 17.1125 15.9971 17.415 16.1689C17.7198 16.3386 17.9499 16.5956 18.1055 16.9395C18.261 17.2811 18.3389 17.7107 18.3389 18.2285C18.3389 18.7465 18.2611 19.1784 18.1055 19.5244C17.9499 19.8683 17.7173 20.1277 17.4082 20.3018C17.0992 20.4736 16.7133 20.5596 16.251 20.5596H15.2627V15.9111H16.2871ZM10.4893 15.874C10.7895 15.8741 11.0345 15.9268 11.2246 16.0303C11.4169 16.1316 11.5586 16.2733 11.6494 16.4561C11.7423 16.639 11.789 16.8507 11.7891 17.0908C11.7891 17.331 11.7424 17.5443 11.6494 17.7295C11.5587 17.9144 11.4186 18.0602 11.2285 18.166C11.0383 18.2717 10.7934 18.3242 10.4951 18.3242H9.38672V15.874H10.4893Z" fill="#6C63FF"/>
                    </svg>
                </a>
                <a href="{% url 'download_scan' scan.id %}" class="btn-primary" target="_blank">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="42" viewBox="0 0 32 42" fill="none">
                    <path d="M27 0C29.7614 0 32 2.23858 32 5V37C32 39.7614 29.7614 42 27 42H5C2.23858 42 8.05346e-09 39.7614 0 37V5C5.15422e-07 2.23858 2.23858 0 5 0H27ZM13.5488 26.8945V31.8848H8.17188L16.0342 39.4102L23.8965 31.8848H18.6211V26.8945H13.5488ZM6.04297 3C4.36238 3.00003 3 4.38973 3 6.10352V32.4795C3 34.1933 4.36238 35.583 6.04297 35.583H10.4727L9.39355 34.5488H6.04297C4.92258 34.5488 4.01465 33.622 4.01465 32.4795V6.10352C4.01465 4.96099 4.92258 4.03421 6.04297 4.03418H26.127C27.2474 4.03418 28.1553 4.96098 28.1553 6.10352V32.4795C28.1553 33.6221 27.2474 34.5488 26.127 34.5488H22.7764L21.6973 35.583H26.127C27.8076 35.583 29.1699 34.1933 29.1699 32.4795V6.10352C29.1699 4.38971 27.8076 3 26.127 3H6.04297ZM15.3906 14.3418C14.8117 14.3418 14.293 14.4795 13.835 14.7549C13.3769 15.0303 13.0148 15.4283 12.749 15.9482C12.4832 16.4661 12.3497 17.0901 12.3496 17.8193C12.3496 18.5465 12.4816 19.1704 12.7451 19.6904C13.0087 20.2105 13.3701 20.6083 13.8281 20.8838C14.2863 21.1593 14.8072 21.2977 15.3906 21.2979C15.7861 21.2979 16.1465 21.2381 16.4707 21.1191C16.7948 20.9979 17.0774 20.8298 17.3193 20.6162C17.5614 20.4001 17.7571 20.1512 17.9062 19.8691C18.0574 19.5872 18.1558 19.2855 18.2012 18.9639L16.9893 18.957C16.9525 19.1553 16.8853 19.332 16.7881 19.4863C16.693 19.6404 16.575 19.7703 16.4346 19.876C16.2964 19.9817 16.1398 20.0622 15.9648 20.1172C15.7921 20.1701 15.6061 20.1963 15.4072 20.1963C15.0486 20.1963 14.7299 20.1071 14.4512 19.9287C14.1746 19.748 13.9558 19.4815 13.7959 19.1289C13.6381 18.774 13.5596 18.3372 13.5596 17.8193C13.5596 17.3105 13.6381 16.8799 13.7959 16.5273C13.9536 16.1726 14.1723 15.9036 14.4512 15.7207C14.7298 15.5357 15.0493 15.4424 15.4102 15.4424C15.6132 15.4424 15.8026 15.4711 15.9775 15.5283C16.1548 15.5835 16.3129 15.6662 16.4512 15.7764C16.5894 15.8866 16.705 16.0211 16.7979 16.1797C16.8907 16.3362 16.9547 16.5161 16.9893 16.7188H18.2012C18.1515 16.342 18.0459 16.007 17.8838 15.7139C17.724 15.4187 17.52 15.1696 17.2715 14.9668C17.023 14.7619 16.7395 14.6067 16.4219 14.501C16.1042 14.3952 15.7603 14.3418 15.3906 14.3418ZM5.90332 14.4346V21.2051H8.15332C8.82759 21.2051 9.40499 21.0699 9.88477 20.7988C10.3666 20.5279 10.7352 20.1387 10.9902 19.6318C11.2474 19.1251 11.3759 18.5186 11.376 17.8135C11.376 17.1106 11.2481 16.5067 10.9932 16.002C10.7381 15.4973 10.3729 15.1097 9.89746 14.8408C9.42429 14.5699 8.85811 14.4346 8.19922 14.4346H5.90332ZM19.3027 14.4346V21.2051H20.457V16.5439H20.5186L22.3535 21.1855H23.2158L25.0508 16.5537H25.1123V21.2051H26.2666V14.4346H24.7949L22.8232 19.3408H22.7461L20.7744 14.4346H19.3027ZM8.13086 15.4961C8.58033 15.4961 8.95625 15.582 9.25879 15.7539C9.56337 15.9235 9.79363 16.1798 9.94922 16.5234C10.1048 16.8651 10.1826 17.2956 10.1826 17.8135C10.1826 18.3313 10.1048 18.7634 9.94922 19.1094C9.79361 19.453 9.56091 19.7117 9.25195 19.8857C8.94295 20.0576 8.55709 20.1436 8.09473 20.1436H7.10645V15.4961H8.13086Z" fill="#6C63FF"/>
                    </svg>
                
                
                </a>
                
                
                <div class="scanTypePt">Dr. {{ scan.doctor.username }} {{ scan.upload_date|date:"Y-m-d" }}</div>
            </div>
            
            <div class="sepLine"></div>
            <!-- <div class="rowAlign2">
                
            </div>
            <div class="rowAlign3">
                                
            </div> -->
            <div class="rowAlign2">
                
                <div class="rowAlign3">
                
                {% if is_dicom %}
                <div class="sliceNumFormat"><div class="slicePadd">Slice</div><span id="sliceNumber">1</span>/ <span id="allSlices">1</span> </div>
                <!-- <hr> -->
                <!-- <h3>DICOM Viewer</h3> -->

                <!-- Slice number display -->
                <!-- <div style="margin-bottom: 10px;">
                <strong>Slice: <span id="sliceNumber">1</span></strong>
                </div> -->

                <!-- DICOM display container -->
                <div id="dicomImage" class="dicomView"></div>
                
                <!-- Slider -->
                <div style="margin-top: 10px;" id="sliderContainer">
                <input type="range" id="sliceSlider" min="0" value="0">
                </div>
                {% endif %}
                </div>
                <div class="rowAlign4">
                    <div class="scanDesc">
                        <div class="scanDescTitle">Scan Description</div>
                        <div class="scanDescSep">
                            <svg xmlns="http://www.w3.org/2000/svg" width="454" height="2" viewBox="0 0 454 2" fill="none">
                            <path d="M0 1H454" stroke="#D9D9D9"/>
                            </svg>
                        </div>
                        <div class="scanDescContent">
                            {{ scan.description }}
                        </div>

                        

                    </div>
                    <div class="scanMessages">
                        <div class="scanDescTitle2">Messages</div>
                        <div class="scanDescSep">
                            <svg xmlns="http://www.w3.org/2000/svg" width="454" height="2" viewBox="0 0 454 2" fill="none">
                            <path d="M0 1H454" stroke="#D9D9D9"/>
                            </svg>
                        </div>

                        <div id="myListContainer" class="scanMessContent">
                            {% for comment in comments %}
                            {% if comment.author.id == request.user.id %}
                            
                            <div class="rightMess">
                                <div class="dateMess">
                                {{ comment.timestamp|date:"Y-m-d H:i" }}   
                                </div>
                                
                            <div class="currentUsr">
                                                         
                                {{ comment.text }}
                                <div class="currentUsrTail">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="19" height="21" viewBox="0 0 19 21" fill="none">
                                    <path d="M19 20.7876C7.01192 22.0868 0.791666 17.0868 0 15.0001C1.92256 13.3466 6.89875 8.3859 8.59517 0C7.46422 16.7718 14.9285 19.4883 19 20.7876Z" fill="#6C63FF"/>
                                    </svg>
                                </div>
                            </div>
                            </div>
                            
                            {% else %}
                            <div class="lefttMess">
                            <div class="dateMess2">
                                {{ comment.timestamp|date:"Y-m-d H:i" }}   
                                </div>
                            <div class="otherUsr">
                                {{ comment.text }}
                                <div class="otherUsrTail">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="19" height="21" viewBox="0 0 19 21" fill="none">
                                    <path d="M0 20.7876C11.9881 22.0868 18.2083 17.0868 19 15.0001C17.0774 13.3466 12.1013 8.3859 10.4048 0C11.5358 16.7718 4.07146 19.4883 0 20.7876Z" fill="#D9D9D9"/>
                                    </svg>
                                </div>
                            </div>
                            </div>
                            {%endif%}
                            {% empty %}
                            <p>No comments yet.</p>
                            {% endfor %}
                            <!-- currentUsr -->
                        </div>
                        
                            <form class="scanMessInput" method="POST">
                            {% csrf_token %}
                            {% render_field form.text class="custom-input-message" placeholder="Type a message..." %}
                            <button class="scanMessageAdded" type="submit">Send</button>
                            </form> 
                        


                    </div>
                </div>
            </div>

        </div>
    </div>
    <script>
    window.addEventListener('load', function () {
        const container = document.getElementById('myListContainer');
        container.scrollTop = container.scrollHeight;
    });
    </script>
    
    <!-- Scripts (must load in order) -->
    <script src="https://unpkg.com/cornerstone-core@2.4.0/dist/cornerstone.js"></script>
    <script src="https://unpkg.com/dicom-parser@1.8.6/dist/dicomParser.min.js"></script>
    <script src="https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/cornerstoneWADOImageLoader.js"></script>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
    const element = document.getElementById("dicomImage");
    const sliceSlider = document.getElementById("sliceSlider");
    const sliceNumber = document.getElementById("sliceNumber");
    const allSlices = document.getElementById("allSlices");

    // Enable the Cornerstone element
    cornerstone.enable(element);

    // Hook up external libraries
    cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
    cornerstoneWADOImageLoader.external.dicomParser = dicomParser;

    // Register image loader
    cornerstone.registerImageLoader('wadouri', cornerstoneWADOImageLoader.wadouri.loadImage);

    // Initialize web workers
    cornerstoneWADOImageLoader.webWorkerManager.initialize({
        webWorkerPath: "https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/webWorker.min.js",
        taskConfiguration: {
        decodeTask: {
            codecsPath: "https://unpkg.com/cornerstone-wado-image-loader@3.0.0/dist/cornerstoneWADOImageLoaderCodecs.min.js"
        }
        }
    });

    const baseImageId = "wadouri:" + window.location.origin + "{{ scan.file.url }}";
    let numberOfFrames = 1;
    let currentFrame = 0;

    function updateSlice(frameIndex) {
        const imageId = baseImageId + "?frame=" + frameIndex;
        cornerstone.loadImage(imageId)
        .then(function (image) {
            cornerstone.displayImage(element, image);
            sliceNumber.textContent = (frameIndex + 1);
            sliceSlider.value = frameIndex;
        })
        .catch(function (err) {
            console.error("Error loading DICOM image", err);
        });
    }

    // Load first image and determine number of frames
    cornerstone.loadAndCacheImage(baseImageId + "?frame=0").then(image => {
        cornerstone.displayImage(element, image);

        // Attempt to extract number of frames
        //const metadata = cornerstoneWADOImageLoader.wadouri.metaDataManager.get(baseImageId);
        //numberOfFrames = metadata ? metadata.NumberOfFrames || 1 : 1;
        numberOfFrames = image.data.string('x00280008') || 1;
        allSlices.textContent = numberOfFrames
        
        const sliderContainer = document.getElementById("sliderContainer");
        if (numberOfFrames <= 1) {
        sliderContainer.style.display = "none"; // Hide slider
        } else {
        sliderContainer.style.display = "block"; // Show slider
        document.getElementById("sliceSlider").max = numberOfFrames - 1;
        }

        sliceSlider.max = numberOfFrames - 1;
        sliceSlider.value = 0;
        sliceNumber.textContent = "1";
    });

    // Handle slider input
    sliceSlider.addEventListener("input", function () {
        currentFrame = parseInt(this.value);
        updateSlice(currentFrame);
    });
    });
    </script>

    <!-- <hr>

    <h2>Comment Section</h2>
    <div>
        {% for comment in comments %}
        <p><strong>{{ comment.author.username }}</strong> at {{ comment.timestamp|date:"Y-m-d H:i" }}:</p>
        <p>{{ comment.text }}</p>
        <hr>
        {% empty %}
        <p>No comments yet.</p>
        {% endfor %}
    </div>

    <h3>Add Comment</h3>
    <form method="POST">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Post</button>
    </form> -->
    <script>
        const date = new Date();
        const day = date.getDate();
        const monthNames = ["January", "February", "March", "April", "May", "June",
                            "July", "August", "September", "October", "November", "December"];
        const month = monthNames[date.getMonth()];
        const year = date.getFullYear();

        document.getElementById("day").textContent = day;
        document.getElementById("monthYear").textContent = `${month} ${year}`;
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('currentTime').textContent = `${hours}:${minutes}`;
    </script>
</body>
</html>